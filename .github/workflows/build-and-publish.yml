name: Build and Publish to GitHub Packages on Tag

on:
  push:
    tags:
      - 'v*' # Matches any tag; adjust for specific patterns like 'v*'

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    # Step 1: Checkout the code
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Log in to GitHub Packages container registry
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # Step 3: Build and tag the Docker image with version tag and 'latest'
    - name: Build and tag Docker image
      run: |
        TAG=$(echo ${GITHUB_REF#refs/tags/}) # Extract the tag
        IMAGE=ghcr.io/${{ github.repository }}
        docker build --build-arg VERSION="$TAG" -t $IMAGE:$TAG ./app
        docker tag $IMAGE:$TAG $IMAGE:latest

    # Step 4: Push the Docker image with version tag
    - name: Push Docker image with version tag
      run: |
        TAG=$(echo ${GITHUB_REF#refs/tags/}) # Extract the tag
        IMAGE=ghcr.io/${{ github.repository }}
        docker push $IMAGE:$TAG

    # Step 5: Push the Docker image with 'latest' tag
    - name: Push Docker image with 'latest' tag
      run: |
        IMAGE=ghcr.io/${{ github.repository }}
        docker push $IMAGE:latest
    
    # Step 6: Update service in Portainer
    - name: Use Portainer Service Webhook Action
      uses: enzodjabali/portainer-service-update-action@v1
      with:
        portainer_url: "${{ secrets.PORTAINER_HOST }}"
        api_key: "${{ secrets.PORTAINER_API_KEY }}"
        endpoint_id: "1"
        service_name: "wayz-preprod_web"