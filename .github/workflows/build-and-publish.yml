name: Build and Publish to GitHub Packages on Tag

on:
  push:
    tags:
      - 'v*' # Matches any tag; adjust for specific patterns like 'v*'

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    # Step 1: Checkout the code
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Log in to GitHub Packages container registry
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # Step 3: Build and tag the Docker image with version tag and 'latest'
    - name: Build and tag Docker image
      run: |
        TAG=$(echo ${GITHUB_REF#refs/tags/}) # Extract the tag
        IMAGE=ghcr.io/${{ github.repository }}
        docker build --build-arg VERSION="$TAG" -t $IMAGE:$TAG ./app
        docker tag $IMAGE:$TAG $IMAGE:latest

    # Step 4: Push the Docker image with version tag
    - name: Push Docker image with version tag
      run: |
        TAG=$(echo ${GITHUB_REF#refs/tags/}) # Extract the tag
        IMAGE=ghcr.io/${{ github.repository }}
        docker push $IMAGE:$TAG

    # Step 5: Push the Docker image with 'latest' tag
    - name: Push Docker image with 'latest' tag
      run: |
        IMAGE=ghcr.io/${{ github.repository }}
        docker push $IMAGE:latest
    
    # Step 6: Trigger deployment update via Portainer
    - name: Trigger deployment update
      run: |
        curl -X PATCH "https://portainer.edj-labs.com/api/endpoints/5/kubernetes/apis/apps/v1/namespaces/wayz-preprod/deployments/wayz-web-preprod" \
           -H "X-API-Key: ${{ secrets.PORTAINER_API_KEY }}" \
           -H "Content-Type: application/strategic-merge-patch+json" \
           -d '{
                 "spec": {
                   "template": {
                     "metadata": {
                       "annotations": {
                         "kubectl.kubernetes.io/restartedAt": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"
                       }
                     }
                   }
                 }
               }'